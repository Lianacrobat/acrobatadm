---
import type { Product } from "@data/products";
import { getProductById } from "@data/productUtils";
import { sendTelegramNotification } from "../../../utils/telegram.js";
---

<div id="favorites-root"></div>

<script>
	import { getProductById } from "@data/productUtils";
	import { sendTelegramNotification } from "../../../utils/telegram.js";
	import { favoritesStorage } from "../../../utils/secureStorage.js";

	function getFavorites() {
		return favoritesStorage.get();
	}
	function saveFavorites(favs: string[]) {
		return favoritesStorage.set(favs);
	}
	function clearFavorites() {
		favoritesStorage.clear();
		window.dispatchEvent(new CustomEvent("favoritesChanged"));
	}

	function renderFavorites() {
		const root = document.getElementById("favorites-root");
		if (!root) return;
		const favIds: string[] = getFavorites();
		const products = favIds
			.map((id: string) => getProductById?.(id))
			.filter(Boolean);

		if (!products || products.length === 0) {
			root.innerHTML = `
				<div class="text-center py-16">
					<svg class="w-20 h-20 text-[var(--text-color-soft)] mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
					<h3 class="text-xl font-semibold mb-2">No tienes productos favoritos</h3>
					<p class="mb-4 text-[var(--text-color-soft)]">Explora nuestra tienda y marca los productos que más te gusten.</p>
					<a href="/tienda" class="inline-flex items-center gap-2 px-6 py-3 rounded-lg bg-gradient-to-r from-[var(--accent-color)] to-[var(--favorite-color)] text-white font-medium hover:from-[var(--accent-color)] hover:to-[var(--favorite-color)] transition">Explorar Tienda</a>
				</div>
			`;
			return;
		}

		root.innerHTML = `
			<div class="flex justify-between items-center mb-6">
				<span class="text-sm text-[var(--text-color-soft)]">( ${products.length} favoritos )</span>
				<button id="clear-favs" class="flex items-center gap-2 px-3 py-2 text-xs text-[var(--favorite-color)] hover:text-[var(--favorite-color)] hover:bg-[var(--favorite-color)]/10 rounded-lg transition-all duration-200 font-medium border border-[var(--favorite-color)]/50 hover:border-[var(--favorite-color)]/50">Eliminar todo</button>
			</div>
			<div class="space-y-4 lg:space-y-0 lg:grid lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 lg:gap-4 xl:gap-6 mb-8">
				${products
					.map(
						(product: any) => {
							const imageUrl = product.images?.[0]?.src || product.images?.[0] || "https://via.placeholder.com/400x400/374151/FFFFFF?text=Sin+Imagen";
							return `
								<!-- Tarjeta para móvil (horizontal) -->
								<div class="flex lg:hidden h-[100px] bg-[var(--cajas)] rounded-lg overflow-hidden shadow hover:shadow-lg transition-shadow">
									<div class="w-[100px] h-[100px] flex-shrink-0 relative">
										<a href="/producto/${product.slug}" class="block w-full h-full">
											<img
												src="${imageUrl}"
												alt="${product.name}"
												class="w-full h-full object-cover"
												loading="lazy"
											/>
										</a>
										<div class="absolute top-2 right-2 z-20">
											<button
												class="favorite-btn w-7 h-7 transition-all duration-200 flex items-center justify-center group bg-white rounded-full p-1 shadow-lg"
												data-id="${product.id}"
												data-name="${product.name}"
												title="Quitar de favoritos"
											>
												<svg
													class="w-4 h-4 text-[var(--favorite-color)] transition-all duration-200"
													fill="currentColor"
													stroke="currentColor"
													viewBox="0 0 24 24"
												>
													<path
														stroke-linecap="round"
														stroke-linejoin="round"
														stroke-width="2"
														d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
													/>
												</svg>
											</button>
										</div>
									</div>
									<div class="flex-1 p-3 flex flex-col justify-between">
										<div>
											<h3 class="text-sm font-medium text-[var(--text-color)] line-clamp-1">
												<a href="/producto/${product.slug}" class="hover:text-[var(--accent-color)] transition-colors">
													${product.name}
												</a>
											</h3>
											<p class="text-xs text-[var(--text-color-soft)] line-clamp-2 mt-1">
												${product.shortDescription?.slice(0, 90) || 'Producto disponible'}...
											</p>
										</div>
										<div class="flex items-center justify-end mt-1">
											<a
												href="/producto/${product.slug}"
												class="text-xs text-[var(--accent-color)] hover:text-[var(--vinculo)] transition-colors"
											>
												Ver detalles →
											</a>
										</div>
									</div>
								</div>

								<!-- Tarjeta para escritorio (cuadrada) -->
								<div class="hidden lg:block bg-[var(--cajas)] rounded-lg shadow transition-shadow overflow-hidden hover:shadow-xl">
									<div class="relative">
										<a href="/producto/${product.slug}" class="block">
											<div class="aspect-square overflow-hidden">
												<img
													src="${imageUrl}"
													alt="${product.name}"
													class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
													loading="lazy"
												/>
											</div>
										</a>
										<div class="absolute top-3 right-3">
											<button
												class="favorite-btn relative w-8 h-8 transition-all duration-200 flex items-center justify-center group bg-white rounded-full p-2 shadow-lg"
												data-id="${product.id}"
												data-name="${product.name}"
												title="Quitar de favoritos"
											>
												<svg
													class="w-5 h-5 text-[var(--favorite-color)] transition-all duration-200"
													fill="currentColor"
													stroke="currentColor"
													viewBox="0 0 24 24"
												>
													<path
														stroke-linecap="round"
														stroke-linejoin="round"
														stroke-width="2"
														d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
													/>
												</svg>
											</button>
										</div>
									</div>
									<div class="p-4">
										<h3 class="font-semibold text-[var(--accent-color)] mb-2 line-clamp-2">
											<a href="/producto/${product.slug}" class="hover:text-[var(--accent-color)] transition-colors">
												${product.name}
											</a>
										</h3>
										<p class="text-sm text-[var(--text-color)] mb-3 line-clamp-2">
											${product.shortDescription || 'Producto disponible'}
										</p>
										<div class="flex items-center justify-between">
											<a
												href="/producto/${product.slug}"
												class="text-sm font-medium transition-colors text-[var(--accent-color)] hover:text-[var(--vinculo)]"
											>
												Ver detalles →
											</a>
										</div>
									</div>
								</div>
							`;
						}
					)
					.join("")}
			</div>
		`;

		const clearBtn = document.getElementById(
			"clear-favs"
		) as HTMLButtonElement | null;
		if (clearBtn) {
			clearBtn.onclick = () => {
				if (confirm("¿Eliminar todos los favoritos?")) clearFavorites();
			};
		}
		root.querySelectorAll(".favorite-btn").forEach((btn) => {
			const button = btn as HTMLButtonElement;
			button.onclick = async () => {
				const id = button.dataset.id,
					name = button.dataset.name;
				favoritesStorage.remove(id);
				await sendTelegramNotification(name, "removed");
				// Disparar evento para sincronizar con otros componentes
				window.dispatchEvent(new CustomEvent("favoritesChanged", {
					detail: { productId: id, isFavorite: false, productName: name }
				}));
				renderFavorites();
			};
		});
	}

	window.addEventListener("favoritesChanged", renderFavorites);
	document.addEventListener("DOMContentLoaded", renderFavorites);
	document.addEventListener("astro:page-load", renderFavorites);
</script>
